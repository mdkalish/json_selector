<apex:page standardController="Contact" standardStylesheets="false" showHeader="false">
  <apex:remoteObjects jsNamespace="RemoteObjectModel">
    <apex:remoteObjectModel name="Contact" fields="Id,Email">
      <apex:remoteObjectField name="Social_Profiles__c" jsShorthand="Social_Profiles"></apex:remoteObjectField>
      <apex:remoteObjectField name="Facebook_URL__c" jsShorthand="Facebook"></apex:remoteObjectField>
      <apex:remoteObjectField name="GitHub_URL__c" jsShorthand="GitHub"></apex:remoteObjectField>
      <apex:remoteObjectField name="LinkedIn_URL__c" jsShorthand="LinkedIn"></apex:remoteObjectField>
      <apex:remoteObjectField name="Twitter_URL__c" jsShorthand="Twitter"></apex:remoteObjectField>
      <apex:remoteObjectField name="Twitter_Followers__c" jsShorthand="Twitter_Followers"></apex:remoteObjectField>
    </apex:remoteObjectModel>
  </apex:remoteObjects>
  <html>
    <head>
      <meta charset="UTF-8"/>
      <script src="https://rawgit.com/mdkalish/json_selector/master/dist/bundle.js"></script>
      <script src="/soap/ajax/35.0/connection.js"></script>
      <script type="text/javascript">

        <!-- Fullcontact part -->
        var Fullcontact = {
          fetch: function () {
            var url = "https://api.fullcontact.com/v2/person.json?email={!Contact.Email}&apiKey=YourApiKey";
            var xmlhttp = new XMLHttpRequest();
            var _this = this;

            xmlhttp.onreadystatechange = function() {
              if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                var response = JSON.parse(xmlhttp.responseText);
                window.fullcontactResponse = response;
                // _this.storeInSObject(response);
                // jSelect(response);
              }
            };

            xmlhttp.open("GET", url, true);
            xmlhttp.send();
          },

          storeInSObject: function (json) {
            var sObject = new sforce.SObject("Contact");
            sObject.Id = '{!Contact.Id}';
            sObject.Social_Profiles__c = json;
            sforce.connection.update([sObject]);
            // console.log('json')
            // console.log(json)
            // console.log('sObject')
            // console.log(sObject)

          },

          insertHTML: function (arr) {
            document.getElementById("fullcontactData").innerHTML = JSON.stringify(arr, null, 4);
          },

          logKeys: function (obj) {
            console.log(Object.keys(obj));
          }
          <!-- //Fullcontact part -->
        }



        <!-- React part -->

        function updateResultingJson(newData) {
          /*
          sObjectData.socialProfiles.map(function(sp) {
            if (sp.type.toLowerCase() === newData.type.toLowerCase()) {
              if (newData.picked === true) {
                sp[newData.keyPart] = newData.fullContactValue;
              } else if (newData.picked === false) {
                sp[newData.keyPart] = newData.sObjectValue;
              }
            }
          })
          */
          console.log('updateResultingJson');
        };

        function jSelect(fullcontactData) {
          var sObjectData = JSON.parse(document.getElementById('socialProfiles').innerHTML);
          window.sObjectData = sObjectData;
          JSelector.render(document.getElementById('JSelectorMountPoint'), window.sObjectData, fullcontactData, updateResultingJson);
        }
        <!-- //React part -->


        <!-- Remote Object part  -->
        <!-- Experimental area -->
        var updateSObject = function() {
          var cntc = new sforce.SObject("Contact");
          cntc.Id = '{!Contact.Id}';
          cntc.Social_Profiles__c = JSON.stringify(sObjectData);

          var customFields = {
            facebook_url: '{!Contact.Facebook_URL__c}',
            github_url: '{!Contact.GitHub_URL__c}',
            linkedin_url: '{!Contact.LinkedIn_URL__c}',
            twitter_url: '{!Contact.Twitter_URL__c}',
            twitter_followers: '{!Contact.Twitter_Followers__c}'
          }

          for (var cf in customFields) {
            if (!customFields[cf]) {
              var name = cf.split('_')[0]
              var refinement = cf.split('_')[1]
              var cfValue = sObjectData.socialProfiles.map(function(sp) {
                if (sp.type.toLowerCase() === name) {
                  return sp[refinement];
                }
              });
              cntc[cf + '__c'] = cfValue;
            }
          };
        };
      </script>
    </head>
    <body>
      <div id="fromFullcontact">
        <button id="fetchFromFullcontactButton" onclick="Fullcontact.fetch()">
          Fetch {!Contact.email} from Fullconcact and show Diff Table
        </button>
        <h3>Fetched from fullcontact.com:</h3>
        <div id="fullcontactData"></div>
      </div>

      <br />

      <div id="diffTables">
        <div id="JSelectorMountPoint"></div>
        <button id="updateSObjectButton" onclick="updateSObject()">Update sObject</button>
      </div>

      <br />

      <div id="fromSObject">
        <h3>Fetched from sObject:</h3>
        <h5>Id</h5>
        <div id="SObjectRecordId">{!Contact.Id}</div>
        <h5>Facebook</h5>
        <button id="updateFacebookButton" onclick="updateFacebook()">Update Facebook Address</button>
        <div id="facebookUrl">Facebook: {!Contact.Facebook_URL__c}</div>
        <h5>Social Profiles</h5>
        <div id="socialProfiles">{!Contact.Social_Profiles__c}</div>
      </div>
    </body>
  </html>
</apex:page>
