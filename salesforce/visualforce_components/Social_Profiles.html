<apex:page standardController="Contact" standardStylesheets="false" showHeader="false">
  <apex:remoteObjects jsNamespace="RemoteObjectModel">
    <apex:remoteObjectModel name="Contact" fields="Id">
      <apex:remoteObjectField name="Social_Profiles__c" rendered="false"></apex:remoteObjectField>
    </apex:remoteObjectModel>
  </apex:RemoteObjects>
  <html>
    <head>
      <meta charset="UTF-8"/>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/0.11.0/fetch.min.js"></script>
      <script src="/soap/ajax/36.0/connection.js"></script>
      <script type="text/javascript">
        var fullcontact = {
          persist: function () {
            console.log("persist");
            return new Promise(function(resolve, reject) {
              var contact = new sforce.SObject("Contact");
              contact.Id = '{!Contact.Id}';
              contact.Social_Profiles__c = JSON.stringify(window.socialProfiles);
              result = sforce.connection.update([contact]);
              if (result[0].getBoolean("success")) {
                console.log("persist: Successfully persisted FullContact data to sObject");
                resolve();
              } else {
                console.error("persist: Error persisting FullContact data to sObject: ");
                console.log(result);
                reject(result);
              };
            });
          }
        };

        var remoteObject = {
          loadSocialProfiles: function () {
            console.log("loadSocialProfiles");
            return new Promise(function(resolve, reject) {
              var rom = new RemoteObjectModel.Contact();
              rom.retrieve({where: {Id: {eq: '{!Contact.Id}'}}}, function(err, res, e) {
                var socialProfiles = res[0].get("Social_Profiles__c");
                if (socialProfiles) {
                  document.getElementById("socialProfiles").innerHTML = socialProfiles;
                  window.socialProfiles = JSON.parse(document.getElementById("socialProfiles").innerHTML);
                  console.log("loadSocialProfiles: Successfully loaded Social Profiles from sObject");
                  resolve();
                } else {
                  console.log("loadSocialProfiles: No socialProfiles");
                  var apiKey = // Your FullContact key.
                  fetch("https://api.fullcontact.com/v2/person.json?{!Contact.Email}&apiKey=" + apiKey)
                    .then(function(response) {
                      return response.json();
                    }).then(function(json) {
                      window.socialProfiles = json.socialProfiles;
                      console.log("fetch: Successfully fetched Social Profiles from FullContact");
                      fullcontact.persist();
                      resolve();
                    });
                }
              });
            });
          },
          updateCustomFields: function() {
            console.log("updateCustomFields");
            var cntc = new sforce.SObject("Contact");
            cntc.Id = '{!Contact.Id}';
            var customFields = {
              facebook_url: '{!Contact.Facebook_URL__c}',
              github_url: '{!Contact.GitHub_URL__c}',
              linkedin_url: '{!Contact.LinkedIn_URL__c}',
              twitter_url: '{!Contact.Twitter_URL__c}',
              twitter_followers: '{!Contact.Twitter_Followers__c}'
            };
            var shouldUpdate = false;

            for (var cf in customFields) {
              if (!customFields[cf]) {
                var name = cf.split('_')[0];
                var refinement = cf.split('_')[1];
                var cfValue = window.socialProfiles.map(function(sp) {
                  if (sp.typeName.toLowerCase() === name && sp[refinement]) {
                    shouldUpdate = true;
                    return sp[refinement];
                  }
                });
                cntc[cf + '__c'] = cfValue;
              }
            };

            if (shouldUpdate) {
              var result = sforce.connection.update([cntc]);
              if (result[0].getBoolean("success")) {
                var success_msg = "Successfully updated Custom Social Profiles, please reload the page to see results."
                console.log(success_msg);
                alert(success_msg);
              } else {
                alert("Error, please report to dev support: " + result);
                console.error(result);
              };
            }
          }
        };

        (function () {
          if (typeof remoteObject.loadSocialProfiles === "function") {
            remoteObject.loadSocialProfiles()
              .then(function() {
                remoteObject.updateCustomFields()
              });
          }
        })();
      </script>
    </head>
    <body>
      <button onclick="fullcontact.persist()">fullcontact.persist</button>
      <button onclick="remoteObject.loadSocialProfiles()">remoteObject.loadSocialProfiles</button>
      <table>
        <tbody>
          <tr id="socialProfiles" style="visibility: collapse"></tr>
        </tbody>
      </table>
    </body>
  </html>
</apex:page>
