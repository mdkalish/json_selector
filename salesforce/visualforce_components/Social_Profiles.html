<apex:page standardController="Contact" standardStylesheets="false" showHeader="false">
  <apex:remoteObjects jsNamespace="RemoteObjectModel">
    <apex:remoteObjectModel name="Contact" fields="Id,Social_Profiles__c,Facebook_URL__c,GitHub_URL__c,LinkedIn_URL__c,Twitter_URL__c,Twitter_Followers__c">
    </apex:remoteObjectModel>
  </apex:RemoteObjects>
  <html>
    <head>
      <meta charset="UTF-8"/>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/0.11.0/fetch.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.6.1/lodash.min.js"></script>
      <script src="/soap/ajax/36.0/connection.js"></script>
      <script type="text/javascript">
        (function () {
          function getFullcontactApiKey() {
            return "YourApiKey";
          }

          function getWantedSocialProfilesTypeNames() {
            return ["facebook", "github", "linkedin", "twitter"];
          }

          function getCustomSocialProfiles() {
            return {
              facebook_url: '{!Contact.Facebook_URL__c}',
              github_url: '{!Contact.GitHub_URL__c}',
              linkedin_url: '{!Contact.LinkedIn_URL__c}',
              twitter_url: '{!Contact.Twitter_URL__c}',
              twitter_followers: '{!Contact.Twitter_Followers__c}'
            };
          }

          function getEmails() {
            return [
              '{!Contact.Email}',
              '{!Contact.Email2__c}',
              '{!Contact.Personal_email_address__c}'
            ].filter(Boolean);
          }

          function createSalesForceContact() {
            var contact = new sforce.SObject("Contact");
            contact.Id = '{!Contact.Id}';
            return contact;
          }

          function persistSocialProfiles(contact, socialProfiles) {
            return new Promise(function(resolve, reject) {
              contact.Social_Profiles__c = socialProfiles;
              result = sforce.connection.update([contact]);
              if (result[0].getBoolean("success")) {
                resolve(JSON.parse(socialProfiles));
              } else {
                reject(result);
              };
            });
          }

          function parseInsideNode(socialProfiles) {
            var socialProfilesNode = document.createElement("div");
            socialProfilesNode.style.display = "none";
            socialProfilesNode.innerHTML = socialProfiles;
            var socialProfilesJson = JSON.parse(socialProfilesNode.innerHTML);
            socialProfilesNode.remove();
            return socialProfilesJson;
          }

          function retrieveSocialProfilesFromSobject() {
            var remoteObjectModel = new RemoteObjectModel.Contact();
            return new Promise(function(resolve, reject) {
              remoteObjectModel.retrieve({where: {Id: {eq: '{!Contact.Id}'}}}, function(err, res, e) {
                resolve({
                  asText: res[0].get("Social_Profiles__c"),
                  customFields: {
                    facebook_url: res[0].get("Facebook_URL__c"),
                    github_url: res[0].get("GitHub_URL__c"),
                    linkedin_url: res[0].get("LinkedIn_URL__c"),
                    twitter_url: res[0].get("Twitter_URL__c"),
                    twitter_followers: res[0].get("Twitter_Followers__c")
                  }
                });
              });
            })
          }

          function getFullcontactUrl(queryEmail) {
            var endpoint = "https://api.fullcontact.com/v2/person.json";
            var query = "?email=" + queryEmail + "&apiKey=" + getFullcontactApiKey();
            var url = endpoint + query;
            return url;
          }

          function allCustomFieldsFilled(socialProfiles) {
            return !_.includes(socialProfiles, undefined);
          }

          function allSocialProfilesPresent(socialProfiles) {
            if (!socialProfiles) { return false }
            var spArray = parseInsideNode(socialProfiles);
            var wanted = getWantedSocialProfilesTypeNames();
            var present = [];
            spArray.map(function(sp) {
              present.push(sp.typeName.toLowerCase());
            });
            return _.intersection(wanted, present).length === wanted.length;
          }

          function getJson(response) {
            return new Promise(function(resolve, reject) {
              resolve(response.json());
            });
          }

          function composeJson(json) {
            return new Promise(function(resolve, reject) {
              for (var csp in customSocialProfiles) {
                if (!customSocialProfiles[csp]) {
                  var name = csp.split('_')[0]
                  var ref = csp.split('_')[1]
                  json.socialProfiles.map(function(sp) {
                    if (sp.typeName.toLowerCase() === name) {
                      customSocialProfiles[csp] = sp[ref];
                      contact[csp + "__c"] = sp[ref];
                    }
                  });
                }
              }
              window.SP = customSocialProfiles;
              resolve();
            })
          }

          function collectFullcontactData() {
            promises = getEmails().map(function(queryEmail) {
              return fetch(getFullcontactUrl(queryEmail))
                      .then(getJson)
                      .then(composeJson);
            });
            return Promise.all(promises);
          }

          function loadSocialProfiles() {
            return new Promise(function(resolve, reject) {
              retrieveSocialProfilesFromSobject().then(function(socialProfiles) {
                if (allCustomFieldsFilled(socialProfiles.customFields)) {
                  resolve(false);
                } else if (allSocialProfilesPresent(socialProfiles.asText)) {
                  resolve(parseInsideNode(socialProfiles.asText));
                } else {
                  collectFullcontactData()
                    // .then(assignToCustomFields)
                    .then(function() {
                      console.log(contact)
                    });
                  // fetch(getFullcontactUrl(queryEmail))
                  // .then(getJson)
                  // .then(function(json) {
                  //   return persistSocialProfiles(
                  //     createSalesForceContact(),
                  //     JSON.stringify(json.socialProfiles)
                  //   );
                  // }).then(function(socialProfiles) {
                  //   resolve(socialProfiles);
                  // });
                }
              });
            });
          }

          // Update sObject Part


          // function assignToCustomFields(customFields, socialProfiles) {
          //   var assignedAny = false;
          //   for (var cf in customFields) {
          //     if (!customFields[cf]) { // IDEA 2: Check two conditions (&& if value retrieved from sObject is empty)
          //       var name = cf.split('_')[0];
          //       var refinement = cf.split('_')[1];
          //       socialProfiles.map(function(sp) {
          //         if (sp.typeName.toLowerCase() === name && sp[refinement]) {
          //           assignedAny = true;
          //           // window.composedJson[cf] = sp[refinement]; // assign here the hash to single final update
          //           contact[cf + '__c'] = sp[refinement];
          //         }
          //       });
          //     }
          //   };
          //   return assignedAny;
          // }

          function updateSobject(contact) {
            contact.Social_Profiles_Updated_At__c = new Date();
            var result = sforce.connection.update([contact]);
            if (result[0].getBoolean("success")) {
              console.info("FullContact update successful, reload the page.");
            } else {
              console.error("FullContact update error, please report to dev support: " + result);
            };
          }

          function updateCustomFields(socialProfiles) {
            var assignedAny = assignToCustomFields(customSocialProfiles, socialProfiles);
            if (assignedAny) { updateSobject(contact) };
          }

          /// Update sObject Part

          if (typeof loadSocialProfiles === "function") {
            var customSocialProfiles = getCustomSocialProfiles();
            var contact = createSalesForceContact();
            // getEmails().map(function(queryEmail) {
              loadSocialProfiles().then(function(socialProfiles) {
                if (socialProfiles) {
                  updateCustomFields(socialProfiles);
                }
              });
            // });
          }
        })();
      </script>
    </head>
    <body>
    </body>
  </html>
</apex:page>
